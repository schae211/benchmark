---
title: "MIBI TNBC"
---

# Set up

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Saez/workflowr_projects/benchmark")
```

Loaded packages.

```{r}
suppressPackageStartupMessages(library(mistyR))
suppressPackageStartupMessages(library(future))
suppressPackageStartupMessages(library(tidyverse))
plan("multisession", workers=12)
```

Loading data generated in MIBI_Analysis.Rmd

```{r}
meta <- readRDS("data/mibi_rowdata.RDS")
all.expr <- readRDS("data/mibi_expression.RDS")
meta.smp <- readRDS("data/mibi_coldata.RDS")
misty.views.smp <- readRDS("data/mibi_misty_views.RDS")
```

```{r hide=TRUE}
# subsampling
subsampling <- FALSE
if (subsampling) {
  frac <- 0.1
  misty.views.smp <- map(misty.views.smp, function(misty.view) {
  sample.index <- sample(1:nrow(misty.view$intraview$data), frac*nrow(misty.view$intraview$data))
  misty.view$intraview$data <- misty.view$intraview$data[sample.index, ]
  misty.view$juxtaview.40$data <- misty.view$juxtaview.40$data[sample.index, ]
  misty.view$paraview.120$data <- misty.view$paraview.120$data[sample.index, ]
  colvars <- misty.view$intraview$data %>% as.matrix %>% matrixStats::colVars()
  misty.view$intraview$data <- misty.view$intraview$data[, colvars > 1e-3]
  misty.view
})
}
```

# Introduction

To extend the functionality of MISTy a new API was implemented to model
the different views which are ultimatively combined in a linear meta model.
This analysis is supposed to test how these new models work on real-world 
datasets.

# Running MISTy

The MISTy views were generated with the following parameters:

- Intraview: Default
- Juxtaview: l = 40
- Paraview: l = 120, zoi = 40

```{r}
cv.folds <- 10
seed <- 42
```

# Running MISTy

```{r}
functions <- c("RF" = ranger_model, "BT" = boosted_trees_model, 
               "NN" = nn_model, "SVM" = svm_model, "MARS" = bagged_earth_model,
               "LMBAG" = bagged_linear_model, "LM" = linear_model)
```

```{r eval=FALSE}
if ("misty.benchmark.mibi_tnbc.RDS" %in% list.files("misty_results")) {
  misty.function <- readRDS("misty_results/misty.benchmark.mibi_tnbc.RDS")
} else {
  misty.function <- map2(functions, names(functions), function(fun, fun.name) {
    results.folders <- map2(misty.views.smp, names(misty.views.smp), 
                          function(sample.views, sample.name) {
      run_misty(views = sample.views, 
                results.folder = paste0("misty_results/mibi_tnbc/",
                                        fun.name,"/",sample.name), 
                model.function = fun, seed = 42, cv.folds = 10)
    })
    misty.results <- collect_results(results.folders)
  })
  saveRDS(misty.function, "misty_results/misty.benchmark.mibi_tnbc.RDS")
}
```

```{r}
# not collecting the results, but writing to the right path!
functions <- functions[names(functions) %in% c("MARS", "LMBAG", "LM")]
misty.function <- map2(functions, names(functions), function(fun, fun.name) {
  results.folders <- map2(misty.views.smp, names(misty.views.smp), 
                        function(sample.views, sample.name) {
    run_misty(views = sample.views, 
              results.folder = paste0("misty_results/mibi_tnbc/",
                                      fun.name,"/",sample.name), 
              model.function = fun, seed = 42, cv.folds = 10)
  })
})
```

