---
title: "MIBI TNBC"
---

# Set up

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Saez/workflowr_projects/benchmark")
```

Loaded packages.

```{r}
suppressPackageStartupMessages(library(mistyR))
suppressPackageStartupMessages(library(future))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(factoextra))
plan("multisession", workers=14)
```

Loading data generated in MIBI_Analysis.Rmd

```{r}
meta <- readRDS("data/mibi_rowdata.RDS")
all.expr <- readRDS("data/mibi_expression.RDS")
meta.smp <- readRDS("data/mibi_coldata.RDS")
misty.views.smp <- readRDS("data/mibi_misty_views.RDS")
```

```{r hide=TRUE}
# subsampling
subsampling <- TRUE
if (subsampling) {
  frac <- 0.1
  misty.views.smp <- map(misty.views.smp, function(misty.view) {
  sample.index <- sample(1:nrow(misty.view$intraview$data), frac*nrow(misty.view$intraview$data))
  misty.view$intraview$data <- misty.view$intraview$data[sample.index, ]
  misty.view$juxtaview.40$data <- misty.view$juxtaview.40$data[sample.index, ]
  misty.view$paraview.120$data <- misty.view$paraview.120$data[sample.index, ]
  colvars <- misty.view$intraview$data %>% as.matrix %>% matrixStats::colVars()
  misty.view$intraview$data <- misty.view$intraview$data[, colvars > 1e-3]
  misty.view
})
}
```


# Introduction

To extend the functionality of MISTy a new API was implemented to model
the different views which are ultimatively combined in a linear meta model.
This analysis is supposed to test how these new models work on real-world 
datasets.

# Running MISTy

The MISTy views were generated with the following parameters:

- Intraview: Default
- Juxtaview: l = 40
- Paraview: l = 120, zoi = 40

```{r}
cv.folds <- 10
seed <- 42
```

TOOD - re-run MISTy with proper function calls!

## Random Forest

```{r warning=FALSE}
if ("mibi_ranger.RDS" %in% list.files("data/mibi_benchmark")) {
  ranger.results <- readRDS("data/mibi_benchmark/mibi_ranger.RDS")
} else {
  cv.folds = 10
  ranger.results.folders <- map2(
    misty.views.smp, names(misty.views.smp), function(smp, name) {
      
      smp %>% run_misty(results.folder = paste0("analysis/results/ranger_", name),
                        cv.folds = cv.folds, seed = seed, model.function = ranger_model,
                        model.name = "ranger")
    })
  ranger.results <- collect_results(ranger.results.folders)
  saveRDS(ranger.results, "data/mibi_benchmark/mibi_ranger.RDS")
}
```

```{r}
mistyR::plot_improvement_stats(ranger.results)
```

## MARS (Multivariante Adaptive Regression Splines)

Running with MARS as ML algorithm to build the view-specific models.

```{r warning=FALSE}
if ("mibi_earth.RDS" %in% list.files("data/mibi_benchmark")) {
  earth.results <- readRDS("data/mibi_benchmark/mibi_earth.RDS")
} else {
  cv.folds = 10
  earth.results.folders <- map2(
    misty.views.smp, names(misty.views.smp), function(smp, name) {
    
      smp %>% run_misty(results.folder = paste0("analysis/results/earth_", name),
                        cv.folds = cv.folds, seed = seed, model.function = bagged_earth_model,
                        model.name = "earth", n.learners = 20)
      
    })
  earth.results <- collect_results(earth.results.folders)
  saveRDS(earth.results, "data/mibi_benchmark/mibi_earth.RDS")
}
```

```{r}
mistyR::plot_improvement_stats(earth.results)
```

## Linear Bagged Model

```{r warning=FALSE}
plan("multisession", workers = 8)
if ("mibi_lmbag.RDS" %in% list.files("data/mibi_benchmark")) {
  lmbag.results <- readRDS("data/mibi_benchmark/mibi_lmbag.RDS")
} else {
  cv.folds = 10
  lmbag.results.folders <- map2(
    misty.views.smp, names(misty.views.smp), function(smp, name) {

      smp %>% run_misty(results.folder = paste0("analysis/results/earth_", name),
                  cv.folds = cv.folds, seed = seed, model.function = bagged_linear_model,
                  model.name = "lmbag", n.learners = 20)
    })
  lmbag.results <- collect_results(lmbag.results.folders)
  saveRDS(lmbag.results, "data/mibi_benchmark/mibi_lmbag.RDS")
}
```

```{r}
mistyR::plot_improvement_stats(lmbag.results)
```

# Comparing the results

## Improvements

```{r fig.width=12, fig.height=14}
colors <- c("earth" = "forestgreen", "ranger" = "blue1", "lm" = "red4")

all.improvements <- rbind(
  ranger.results$improvements %>% mutate(method = "ranger"),
  earth.results$improvements %>% mutate(method = "earth"),
  lmbag.results$improvements %>% mutate(method = "lm")
)

all.improvements %>%
  filter(measure %in% c("gain.R2", "multi.R2", "intra.R2")) %>%
  mutate(measure = factor(measure, 
                          levels = c("gain.R2", "multi.R2", "intra.R2"))) %>%
  ggplot() +
  geom_boxplot(aes(x=target, y=value, col = method)) +
  facet_wrap(~ measure, ncol = 1, scales = "free") +
  theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        axis.text.x.bottom = element_text(vjust = 0.4)) +
  scale_colour_manual(values = colors)
```

## View Contributions

Random Forest (ranger):

```{r}
mistyR::plot_view_contributions(ranger.results)
```

Boxplot to look at the variability

```{r fig.width=6, fig.height=6}
ranger.results$contributions %>%
  filter(!str_starts(view, "p\\."), view != "intercept") %>%
  ggplot() +
  geom_boxplot(aes(x = target, y = value)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ view, ncol = 1)
```

Bagged MARS (earth):

```{r}
mistyR::plot_view_contributions(earth.results)
```

Boxplot to look at the variability

```{r fig.width=6, fig.height=6}
earth.results$contributions %>%
  filter(!str_starts(view, "p\\."), view != "intercept") %>%
  ggplot() +
  geom_boxplot(aes(x = target, y = value)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ view, ncol = 1)
```

Bagged Linear Model

```{r}
mistyR::plot_view_contributions(lmbag.results)
```

Boxplot to look at the variability

```{r fig.width=6, fig.height=6}
lmbag.results$contributions %>%
  filter(!str_starts(view, "p\\."), view != "intercept") %>%
  ggplot() +
  geom_boxplot(aes(x = target, y = value)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ view, ncol = 1)
```

## Importances

Random Forest

```{r fig.width=6, fig.height=6}
mistyR::plot_interaction_heatmap(ranger.results, view = "intra", clean = TRUE)
mistyR::plot_interaction_heatmap(ranger.results, view = "juxta.40", clean = TRUE)
mistyR::plot_interaction_heatmap(ranger.results, view = "para.120", clean = TRUE)
```

Bagged MARS

```{r fig.width=6, fig.height=6}
mistyR::plot_interaction_heatmap(earth.results, view = "intra", clean = TRUE)
mistyR::plot_interaction_heatmap(earth.results, view = "juxta.40", clean = TRUE)
mistyR::plot_interaction_heatmap(earth.results, view = "para.120", clean = TRUE)
```

Bagged Linear Model

```{r fig.width=6, fig.height=6}
mistyR::plot_interaction_heatmap(lmbag.results, view = "intra", clean = TRUE)
mistyR::plot_interaction_heatmap(lmbag.results, view = "juxta.40", clean = TRUE)
mistyR::plot_interaction_heatmap(lmbag.results, view = "para.120", clean = TRUE)
```

